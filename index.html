<!DOCTYPE html>
<html>
  <head>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="custom.css" />
  </head>
  <body>
    <div class="container">
      <div class="main-body">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="main-breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="index.html">Home</a></li>
            <li class="breadcrumb-item">
              <a href="javascript:void(0)">User</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
              User Profile
            </li>
          </ol>
        </nav>
        <!-- /Breadcrumb -->

        <div class="row gutters-sm">
          <div class="col-md-4 mb-3">
            <div class="card">
              <div class="card-body">
                <h6 class="d-flex align-items-center mb-3">My Classes</h6>
                <div id="course-list"></div>
                <div class="d-flex align-items-center mb-2 mt-2">
                  <input
                    type="text"
                    class="form-control"
                    id="course-input"
                    placeholder="Enter a course here"
                  />
                </div>
                <div class="d-flex align-items-center mb-2 mt-2">
                  <input
                    type="text"
                    class="form-control"
                    placeholder="Enter Professor..."
                    id="professor"
                  />
                  <button
                    type="button"
                    id="add"
                    class="btn btn-primary ms-1 text-nowrap"
                  >
                    <i class="bi bi-plus"></i> Add
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-8">
            <div class="card mb-3">
              <div class="card-body">
                <h6 class="d-flex align-items-center mb-3" id="courses">
                  Lectures
                </h6>
                <div id="lecture-list"></div>
                <div class="row">
                  <div class="ml-auto">
                    <button
                      class="btn btn-outline-primary"
                      onclick="openForm()"
                    >
                      Import
                    </button>

                    <div class="form-popup" id="myForm">
                      <form action="/action_page.php" class="form-container">
                        <label for="course"><b>Course</b></label>
                        <input
                          type="text"
                          placeholder="Enter Course name..."
                          id="course-name"
                        />
                        <label for="name"><b>Name</b></label>
                        <input
                          type="text"
                          placeholder="Enter lecture name..."
                          id="lecture-name"
                        />

                        <label for="week"><b>Week</b></label>
                        <input
                          type="text"
                          placeholder="Enter Week..."
                          id="week"
                        />

                        <label for="date"><b>Due Date</b></label>
                        <input type="date" id="date" />

                        <!-- move professor property to add class section -->
                        <!-- <label for="professor"><b>Professor</b></label>
                        <input
                          type="text"
                          placeholder="Enter Professor..."
                          id="professor"
                        /> -->

                        <label for="file"><b>Video Import</b></label>
                        <input type="file" id="file-selector" required />

                        <hr />
                        <button type="button" class="btn" id="submit">
                          Submit
                        </button>
                        <button
                          type="button"
                          class="btn cancel"
                          onclick="closeForm()"
                        >
                          Close
                        </button>
                      </form>
                    </div>

                    <button id="summarize" class="btn btn-outline-primary">
                      Summarize
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div class="row gutters-sm">
              <div class="col-sm-12 mb-3">
                <div class="card h-100">
                  <div class="card-body">
                    <h6 class="d-flex align-items-center mb-3">
                      Your week is here:
                    </h6>
                    <div class="" id="summary">
                      summ Pan-searing is the best way to cook a steak, and it's
                      also the easiest! I love the kind of dinner that you can
                      cook without a recipe. The truth is, good cooking is more
                      about technique than recipes and the best dishes are often
                      the simplest to prepare. A properly cooked steak is case
                      in point.
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      document.addEventListener("keydown", function (e) {
        if (e.which === 123) {
          require("remote").getCurrentWindow().toggleDevTools();
        } else if (e.which === 116) {
          location.reload();
        }
      });

      let courses = [];

      // Add a class to the class list.
      let button = document.querySelector("#add");
      button.addEventListener("click", () => {
        // 1. Read the text in #course-input.
        let input = document.querySelector("#course-input");
        let text = input.value;

        if (!text.length) return;

        let course = {
          text: text,
          lectures: [], // list of lectures
        };
        // 3. Append the new course object to courses
        courses.push(course);
        saveCourses();

        // 4. Create a new task item and attach it to #todo-list.
        addCourse(course);

        // 5. Clear #task-input.
        input.value = "";
      });

      //inner import lecture button
      let button_submit = document.querySelector("#submit");
      button_submit.addEventListener("click", () => {
        // 1. Read the text in #course-input.

        let input_course = document.querySelector("#course-name");
        let input_name = document.querySelector("#lecture-name");
        let input_week = document.querySelector("#week");
        let input_due = document.querySelector("#date");

        let course = input_course.value;
        let name = input_name.value;
        let due = input_due.value;
        let week = input_week.value;

        let lecture = {
          Name: name,
          Due: due,
          Week: week,
          Summary: "none",
        };

        //######################################### asynchronous problem
        //############################################## sumamrize 추가분입니다
        //text file generation
        let text_to_summarize = "full_text";
        //make summary
        //!!problem: function returns undefined
        //So, access to summary via file

        lecture_summarizer(text_to_summarize)
          .then(() => {
            console.log("created");
            let fs = require("fs");
            let path = require("path"),
              filePath = path.join(__dirname, "/src/lecture_summary.txt");
            var text = fs.readFileSync(filePath, "utf8");

            lecture.Summary = text;

            //debugging purpose
            console.log("first then: ", lecture.Summary);
          })
          .then(() => {
            // 3. Append the new course object to courses
            let target_idx = courses.findIndex((element) => element === course);
            if (target_idx !== -1) {
              courses[target_idx].lectures.push(course);
              saveCourses();
              // 4. Create a new task item and attach it to #todo-list.
              //TODO
              addCourse(course);
            }

            //for debugging purpose
            console.log(course);
            console.log(name);
            console.log(week);
            console.log(due);
            // 5. Clear #input.
            input_course.value = "";
            input_name.value = "";
            input_due.value = "";
            input_week.value = "";
          });

        //FYI##########################################################
        //Data structure: courses -> course -> course.Lectures -> lecture
        // lecture object에 있는 값들을 바탕으로 front-end에서 보일 수 있도록 구현해주세요!!!
        //##########################################################

        //#############################################파일 change 이벤트에 대한 로직은 찬원님의 branch를 따라야 합니다. 현재 이 파일은 로직에 오류가 있습니다.

        //more functions needed
        // const lib = require("./lib.js");
        // //video to audio converter--from user video input
        // const fileSelector = document.getElementById("file");
        // fileSelector.addEventListener("change", (event) => {
        //   const fileList = event.target.files;
        //   // console.log(fileList);
        //   let fileName = fileList[0].name;
        //   lib.getAudio(fileName, function (err) {
        //     /*error call back function migrate to the function declaration */
        //   });
        // });
      });

      function loadCourses() {
        let lastCourses = localStorage.getItem("courses");
        if (!lastCourses) return;

        courses = JSON.parse(lastCourses);
        courses.forEach(addCourse);
      }

      function saveCourses() {
        localStorage.setItem("courses", JSON.stringify(courses));
      }

      // Class add/delete function
      function addCourse(course) {
        let div = document.createElement("div");
        div.className = "row";

        let line = document.createElement("div");
        line.className = "col-sm-9";
        line.textContent = course.text;
        line.onclick = function () {
          updateLectures(course);
        };
        div.appendChild(line);

        let buttonRemove = document.createElement("button");
        buttonRemove.className = "btn btn-sm btn-danger";
        buttonRemove.innerHTML = '<i class="bi bi-file-minus"></i>';
        div.appendChild(buttonRemove);

        buttonRemove.addEventListener("click", () => {
          div.remove();
          courses = courses.filter((t) => t !== course);
          saveCourses();
        });

        let list = document.querySelector("#course-list");

        let hr = document.createElement("hr");
        let hrdiv = document.createElement("div");
        hrdiv.className = "col-sm-9";
        hrdiv.appendChild(hr);
        div.appendChild(hrdiv);

        list.appendChild(div);
      }

      // Called when lecture is clicked by user
      function updateSummary(lecture) {
        let summary = document.querySelector("#summary");
        summary.innerHTML =
          lecture.Summary === "none"
            ? "Not summarized yet..."
            : lecture.Summary;
      }

      // Called when course is clicked by user.
      function updateLectures(course) {
        // empty inner html
        let list = document.querySelector("#lecture-list");
        list.innerHTML = "";

        // Set lecture name
        let name = document.querySelector("#lecture-name");
        name.innerHTML = course.text + " Lectures";

        // Show lectures
        div = document.createElement("div");
        div.className = "";
        course.lectures.forEach((lecture) => {
          summary_icon = "";
          if (lecture.summary !== "") {
            summary_icon =
              '<button class="btn btn-sm btn-success"><i class="bi bi-check"></i></button>';
          }
          lectureDiv = document.createElement("div");
          lectureDiv.onclick = () => updateSummary(lecture);
          lectureDiv.innerHTML = `
          <div class="row">
            <div class="col-sm-3">
                <h6 class="mb-0">4</h6>
            </div>
            <div class="col-sm-6 text-secondary">lecture 4</div>
            ${summary_icon}
          </div>
          <hr />
          `;
          div.appendChild(lectureDiv);
        });
        list.appendChild(div);
      }

      window.addEventListener("load", () => {
        loadCourses();
      });
      //open popup
      function openForm() {
        document.getElementById("myForm").style.display = "block";
      }

      //close popup
      function closeForm() {
        document.getElementById("myForm").style.display = "none";
      }

      //########################################################################
      //##############################################submit button에서 사용하는 summarize function 입력 값을 반영하도록 바꿀 필요가 있습니다.
      //summarizing
      // src = https://www.npmjs.com/package/@trashhalo/node-summarizer#meth
      async function lecture_summarizer(text_to_summarize) {
        let SummarizerManager = require("node-summarizer").SummarizerManager;

        //TODO-- get text from video
        text_to_summarize =
          "Boris Johnson has been issued with a county court judgement for allegedly failing to pay a debt.Court records show he was issued with the judgment for a figure of £535.Johnson's spokesman described the judgement against him as vexatious and spurious.The claim relates to an allegation of defamation, the Daily Mail reported.See more stories on Insider's business page.Boris Johnson has been issued with a county court judgement for an lleged unpaid debt.The judgement, revealed by the Private Eye magazine on Wednesday and seen by Insider, shows that the judgement against the UK Prime Minister came last October after failed to pay the debt of £535. Despite the order being issued more than six months ago, it is rated as an unsatisfied record, suggesting that it has not been paif by the prime minister. Johnson's Downing Street residence is listed on the court judgement. It is not clear what the alleged debt relates to, but such judgements are issued when a person or organisation takes action against someone claiming they owe them money and the person does not respond.However, a spokesman for Johnson said they were moving at speed to get this vexatious and spurious claim removed, adding that the courts do have the power to strike down vexatious claims.The Daily Mail reported that the claim came from a woman alleging defamation by the prime minister. Asked if the public should be worried about the prime minister's financial situation, a spokesperson replied you should not be worried, no. The judgement posed awkward questions for the prime minister, whose private financial arrangements have been under significant scrutiny in recent months."; //this is full-text from Google API
        let number_of_sentences = 3; //output lines

        let Summarizer = new SummarizerManager(
          text_to_summarize,
          number_of_sentences
        );

        //summarizing

        Summarizer.getSummaryByRank().then((summary_object) => {
          // return summary_object.summary;
          let summary = summary_object.summary;

          // lecture_summary.txt is tentative name, modify on your choice
          fs = require("fs");
          // TODO-- change output file name if you make summary text file
          fs.writeFileSync(
            "./src/lecture_summary.txt",
            summary,
            function (err) {
              if (err) return console.log(err);
            }
          );
          //debug
          console.log(summary);
        });
      }
      //##############################################

      //tentative functions
      //3. Summary/ Full-text change button

      //4. Display the text that matches the type of current state (Summary / Full-text)
    </script>
  </body>
</html>
